<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Wikidataを用いた検索システム</title>

<link rel="stylesheet" href="style.css">
<!-- KG検索用のライブラリ読み込み -->
<script src="KGSearch.js"></script> 

<script>
//詳細表示ページ用の設定
const keylink = "item";	//リンクのkeyとする変数
const detail_html = "details.html"; //詳細表示用のHTMLファイル

let offset = 0; 


let search_cond = 
    [
        {"id":"cond1", "ctext":"分類", "cond":"wdt:P31/wdt:P279*", "val":"wd:Q3918", "type":"ID", "const":true },
        {"id":"cond2", "ctext":"国", "cond":"wdt:P17", "val":"", "type":"getID", "const":false },
        {"id":"cond3", "ctext":"所在地（例：寝屋川市，大阪府）", 
            "cond":"wdt:P131/rdfs:label|wdt:P131/wdt:P131/rdfs:label", "val":"", "type":"STR-ja", "const":false },
        {"id":"cond4", "ctext":"設立年（XXXX年以降，例：1990）", 
            "cond":"?item wdt:P571 ?p571 . FILTER(?p571 >= \"####-01-01T00:00:00Z\"^^xsd:dateTime)", 
            "val":"", "type":"REPLACE", "const":false },
        {"id":"cond5", "ctext":"設立年（XXXX以前，例：2010）", 
            "cond":"?item wdt:P571 ?p571 . FILTER(?p571 <= \"####-12-31T23:59:59Z\"^^xsd:dateTime)", 
            "val":"", "type":"REPLACE", "const":false },
    ];

let search_prop = 
    [
        {"id":"opt1", "prop":"wdt:P17", "pname":"国", "optional":false },
        {"id":"opt2", "prop":"wdt:P131", "pname":"所在地", "optional":false },
        {"id":"opt3", "prop":"wdt:P18" , "pname":"画像", "optional":true } , 
        {"id":"opt4", "prop":"wdt:P856", "pname":"公式ウェブサイト", "optional":true },
        {"id":"opt5", "prop":"wdt:P571", "pname":"設立日", "optional":false },
    ];

window.addEventListener('load', async () => {
	const sendButton = document.getElementById('send');
    const contButton = document.getElementById('cont');
    
    const serchCondDiv = document.getElementById('search_cond_div');
    const serchPropDiv = document.getElementById('search_prop_div');
    serchCondDiv.innerHTML = loadSearchConds(search_cond);
    serchPropDiv.innerHTML = loadSearchProps(search_prop);

	//検索実行ボタンの処理
	sendButton.addEventListener('click', async () => {
        offset = 0;  
        document.getElementById("result_div").innerHTML="";
        contButton.style.display="none";
        makeQuery();
		//makeWikidataQuery();
	}, false);

    //続きを検索実行ボタンの処理
	contButton.addEventListener('click', async () => {
        offset += 50;
        makeQuery();
	}, false);

    //パラメータ(?key=XXXX)を使ったアクセスの処理
    var param = location.search;
    if(param!=""){
        document.getElementById('QID').value = decodeURI(param.replace("?key=",""));
        document.getElementById('head').style.display = 'none';
        document.getElementById('menu').style.display = 'none';
		makeQuery();
		//makeWikidataQuery();
    }

}, false);

//検索に用いるSPARQLクエリを生成し，実行する
async function makeQuery(){
    const endpoint = "https://query.wikidata.org/sparql";
    const resultArea = document.getElementById('result_div');
	let query = document.getElementById('query_area').value;
    const contButton = document.getElementById('cont');
   
    const delailsArea = document.getElementById('details_div');
    delailsArea.innerHTML='<iframe src="" name="details"style="width: 400px; height: 80hv;"></iframe>';

	//  検索条件を設定するには下記のコメントを外す 
	//名称の検索にWikidataのAPIを使用する際は下記のコメントを外す
	
    let conditions = "{\n";
    let ids; 

    //名称の処理
    const textLABEL = document.getElementById('LABEL').value;
    if(textLABEL!=""){
        ids = await getWdIDs(textLABEL);
        // const ids = await getWdIDsBySE(textLABEL);//        
        const vals = ids.join(" ").replaceAll("Q","wd:Q"); 
        
        //const vals = await getWdID(textLABEL); //1個目のみ使う場合
        
        conditions+= 'VALUES ?item {'+"wd:"+vals+'}\n';
        
        // query = query.replace("{",'{\n\tVALUES ?item {'+vals+'}');
        // document.getElementById('query_area2').value = query;
    }  

    //検索条件の設定
    for(let i=0; i<search_cond.length ;i++){
        const condID = search_cond[i].id;
        const textCond = document.getElementById(condID).value;
        const textVal = document.getElementById(condID+'val').value;
        if(textCond!="" && textVal!=""){
            if(search_cond[i].type =="ID"){
                conditions+= '?item '+textCond+' '+textVal+ '.\n';
            }
            else if(search_cond[i].type =="getID"){
                const qid = await getWdID(textVal); //IDを検索で取得     
                conditions+= '?item '+textCond+' '+"wd:"+qid+ '.\n';
            }
            else if(search_cond[i].type =="STR-ja"){
                conditions+= '?item '+textCond+' "'+textVal+ '"@ja .\n';
            }
            else if(search_cond[i].type =="REPLACE"){
                conditions+= textCond.replace('####',textVal)+'\n';
            }
        }  
    }

    //検索項目の設定
    let opt_select = "";
    let options = "";
	for(let i=0;i<search_prop.length;i++){
        const optid = search_prop[i].id;        
        const textOpt = document.getElementById(optid).value;
        const textPname = document.getElementById(optid+'_name').value;
        search_prop[i].prop = textOpt;
        search_prop[i].pname = textPname;
        
        if(textOpt!=""){
            opt_select += '?'+optid+'Label';
            if(document.getElementById(optid+'_ck').checked){
                options += 'OPTIONAL{?item '+ textOpt+' ?'+optid+' .}\n';
                search_prop[i].optional = true;
            }
            else{
                options += '?item '+ textOpt+' ?'+optid+' .\n';
                search_prop[i].optional = false;
            }
        }
    }
    console.log(JSON.stringify(search_prop,null,'  '));
	
    query = query.replace("{",conditions+options)
                 .replace("?itemLabel","?itemLabel "+opt_select);
    // query = query.replace("{",conditions);

    if(offset!=0){
        query += "OFFSET "+offset; 
    }

    document.getElementById('query_area2').value = query;

    //SPARQLクエリの実行
	document.getElementById('result_box').style.display="flex";
	
    //showSearchIng(resultArea);
    dispLoading("検索中...");			

	const resultData = await sendSPARQLQuery(endpoint, query);
    
    removeLoading();


	document.getElementById('resjson_area').value = JSON.stringify(resultData,null,'  ');
    showResult(resultData,resultArea); //クエリ結果の表示【テーブル表示用】
    //showResultDetails(resultData,resultArea); //クエリ結果の表示【詳細表示用】

    //「続きを検索」の処理
    if(ids!=null){ //WikiMedia API 利用時        
        if(resultData.results.bindings.length == 0 && ids.length==50){
            //繰り返し適用されてしまうので，いったん，外す
            // console.log("検索結果がゼロのため「続き」を自動検索");
            // offset += 50;
            // makeQuery();
            contButton.style.display="none";
        }
        else if(ids.length==50){
            contButton.style.display="block";
        }
    }
    else if(resultData.results.bindings.length == 50){ //SPARQLのみ利用時
        contButton.style.display="block";
    }
    else{
        contButton.style.display="none";
    }

}
//Wikidata ID の検索を実行する　※こちらは廃止の方向で？
async function makeWikidataQuery(){
    const resultArea = document.getElementById('result_div');
    // let options = document.getElementById('query_area').value;
    // const endpoint ="https://www.wikidata.org/w/api.php";
	
	const textLABEL = document.getElementById('LABEL').value;
	if(textLABEL==""){
		alert("検索キーワードを入力してください");
		return;
	}
	const endpoint ="https://www.wikidata.org/w/api.php";
    const options ="?action=wbsearchentities&search="+textLABEL+"&language=en&limit=50&format=json";
	document.getElementById('query_area2').value = options;

    document.getElementById('result_box').style.display="flex";
    showSearchIng(resultArea);

    const resultData = await sendWdQuery(endpoint,options);
    document.getElementById('resjson_area').value = JSON.stringify(resultData,null,'  ');  
    
    //showWdResult(resultData,resultArea); 
	showWdResultWithLink(resultData,resultArea); //詳細表示との連携用
}

</script>
</head>

<body>
<header id="head" >
	<h1>Wikidataを用いた検索システム</h1>
</header>

<!-- 検索条件設定の領域 -->
<div id="menu" class="container">
	<div style="margin-top:4px;">
        <b>大学</b>[<a href="file:///D:/GitHub/KGSearchForWD/src/details.html?key=wd:Q3918">wd:Q3918</a>]の検索<br>
		<input id="LABEL" type="text" value="" size="40"/>         
        <input type="button" id="send" value="検索の実行" style="margin-top:8px; ">
        <br>
        <!-- 検索条件を設定するには下記のコメントを外す  -->
		 <hr>
         <b>詳細検索</b>:<br>
         <div id="search_cond_div"></div>
         <!-- <span style="display: block;">分類：
            <input id="cond1" class="cond" type="text" value="wdt:P31/wdt:P279*" size="20"/>
            <input id="val1" type="text" value="wd:Q3918" size="20"/><br></span>
        所在地（例：寝屋川市，大阪府）：
            <input id="cond2" class="cond" type="text" value="wdt:P131/rdfs:label|wdt:P131/wdt:P131/rdfs:label" size="20"/>
            <input id="val2" type="text" value="" size="20"/><br>
        設立年（XXXX年以降，例：1990）：
            <input id="cond3" class="cond" type="text" value='?item wdt:P571 ?p571 . FILTER(?p571 >= "####-01-01T00:00:00Z"^^xsd:dateTime)' size="20"/>
            <input id="val3" type="text" value="" size="20"/><br>
        設立年（XXXX以前，例：2010）：
            <input id="cond4" class="cond" type="text" value='?item wdt:P571 ?p571 . FILTER(?p571 <= "####-12-31T23:59:59Z"^^xsd:dateTime)' size="20"/>
            <input id="val4" type="text" value="" size="20"/><br> -->
        <hr> 
		<!-- 下記の「クエリの表示・非表示」ボタンは，必要がなければコメントアウトしてもよい  -->
		<input type="button" id="dis_b" value="クエリの表示"
			onclick="document.getElementById('query').style.display = 'block';
			document.getElementById('dis_b').style.display = 'none';
			document.getElementById('none_b').style.display = 'block';">
		<input type="button" id="none_b"  value="クエリの非表示" style="display:none"
			onclick="document.getElementById('query').style.display = 'none';
			document.getElementById('dis_b').style.display = 'block';
			document.getElementById('none_b').style.display = 'none';">
	</div>

<div id="query" style="display:none">
<b>検索項目設定</b>：<br>
<div id="search_prop_div"></div>
<b>置き換え前のクエリ</b>：<br>
<!-- 一覧検索用のサンプルクエリ：[詳細表示]を試すときは下記のクエリと入れ替える-->
<textarea id="query_area" class="t_area" rows="10">
PREFIX wd: <http://www.wikidata.org/entity/>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX wikibase: <http://wikiba.se/ontology#>
    
select DISTINCT ?item ?itemLabel
where{
    SERVICE wikibase:label { bd:serviceParam wikibase:language "ja,en". }
}
LIMIT 50		
</textarea>
<br>
<b>置き換え後のクエリ</b>：<br>
<textarea id="query_area2" class="t_area" rows="10" >
</textarea>
<br>
<b>クエリ実行結果の戻り値(JSON形式）</b>：<br>
<textarea id="resjson_area"  class="t_area" rows="10" >
</textarea>
</div>
</div>

<!-- 結果表示用の領域 -->
<div id="result_box" style=" display: none;  ">
	<div>
        <div id="result_div"  class="result_div" > </div>
        <input type="button" id="cont" value="続きを検索" style=" display: none;" >
    </div>
	<!-- <div id="result_div"  class="container" style="flex: 1;"></div> -->
	<!-- 詳細表示画面を使用するときは，この下のコメントアウトを外す -->
	<div id="details_div" >
		<iframe src="" name="details"style="width: 400px; height: 80hv;"></iframe>
	</div>
</div>
<hr>
</body>
</html>