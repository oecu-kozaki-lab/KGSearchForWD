<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Wikidataを用いた検索システム</title>

<link rel="stylesheet" href="style.css">
<!-- KG検索用のライブラリ読み込み -->
<script src="KGSearch.js"></script> 

<script>
//詳細表示ページ用の設定
const keylink = "key";	//リンクのkeyとする変数
const detail_html = "details.html"; //詳細表示用のHTMLファイル

window.addEventListener('load', async () => {
	const sendButton = document.getElementById('send');

	//検索実行ボタンの処理
	sendButton.addEventListener('click', async () => {
        //makeQuery();
		makeWikidataQuery();
	}, false);

    //パラメータ(?key=XXXX)を使ったアクセスの処理
    var param = location.search;
    if(param!=""){
        document.getElementById('QID').value = decodeURI(param.replace("?key=",""));
        document.getElementById('head').style.display = 'none';
        document.getElementById('menu').style.display = 'none';
		//makeQuery();
		makeWikidataQuery();
    }

}, false);

//検索に用いるSPARQLクエリを生成し，実行する
async function makeQuery(){
    const endpoint = "https://query.wikidata.org/sparql";
    const resultArea = document.getElementById('result_div');
	let query = document.getElementById('query_area').value;

	//  検索条件を設定するには下記のコメントを外す 
/*	const textLABEL = document.getElementById('LABEL').value;
    if(textLABEL!=""){
        query = query.replace( '#FILTER(contains(?LABEL,"#LBL#"))', 
								'FILTER(contains(?LABEL,"'+textLABEL+'"))' )
					.replace('#?s rdfs:label ?LABEL.','?s rdfs:label ?LABEL.');
		document.getElementById('query_area2').value=query; //置換後のクエリを保存
    }
*/
/*	
	const textINPUT = document.getElementById('INPUT').value;
    if(textINPUT!=""){
        query = query.replace( '?INPUT', '"'+textINPUT+'"@ja' );
		document.getElementById('query_area2').value=query; //置換後のクエリを保存
    }
*/
/*
	const textYEAR = document.getElementById('YEAR').value;
	if(textYEAR!=""){
        query = query.replace( '#FILTER(?p571 >= "####-01-01T00:00:00Z"^^xsd:dateTime)', 
								'FILTER(?p571 >= "'+textYEAR+'-01-01T00:00:00Z"^^xsd:dateTime)' );
		document.getElementById('query_area2').value=query; //置換後のクエリを保存
    }
*/

//WikidataのQIDで検索する際（主に詳細表示用）は下記のコメントを外す
/*
	const textQID = document.getElementById('QID').value;
    if(textQID!=""){
        query = query.replace( '?QID', textQID );
        document.getElementById('query_area2').value=query; 
    }
*/

	//名称の検索にWikidataのAPIを使用する際は下記のコメントを外す
    const textLABEL = document.getElementById('LABEL').value;
    if(textLABEL!=""){
        const ids = await getWdIDs(textLABEL);
        const vals = ids.join(" ").replaceAll("Q","wd:Q"); 
        query = query.replace("#VALUES",'VALUES ?s {'+vals+'}');
        document.getElementById('query_area2').value = query;
    }  


    //SPARQLクエリの実行
	document.getElementById('result_box').style.display="flex";
	showSearchIng(resultArea);
    
	const resultData = await sendSPARQLQuery(endpoint, query);
    
	document.getElementById('resjson_area').value = JSON.stringify(resultData,null,'  ');
    showResult(resultData,resultArea); //クエリ結果の表示【テーブル表示用】
    //showResultDetails(resultData,resultArea); //クエリ結果の表示【詳細表示用】

}
//Wikidata ID の検索を実行する
async function makeWikidataQuery(){
    const resultArea = document.getElementById('result_div');
    // let options = document.getElementById('query_area').value;
    // const endpoint ="https://www.wikidata.org/w/api.php";
	
	const textLABEL = document.getElementById('LABEL').value;
	if(textLABEL==""){
		alert("検索キーワードを入力してください");
		return;
	}
	const endpoint ="https://www.wikidata.org/w/api.php";
    const options ="?action=wbsearchentities&search="+textLABEL+"&language=en&limit=50&format=json";
	document.getElementById('query_area2').value = options;

    document.getElementById('result_box').style.display="flex";
    showSearchIng(resultArea);

    const resultData = await sendWdQuery(endpoint,options);
    document.getElementById('resjson_area').value = JSON.stringify(resultData,null,'  ');  
    
    showWdResult(resultData,resultArea); 
	//showWdResultWithLink(resultData,resultArea); //詳細表示との連携用
}

</script>
</head>

<body>
<header id="head" >
	<h1>Wikidataを用いた検索システム</h1>
</header>

<!-- 検索条件設定の領域 -->
<div id="menu" class="container">
	<div style="margin-top:4px;">
		<!-- 検索条件を設定するには下記のコメントを外す  -->
		 <b>検索条件の設定：</b>:<br>
		 <!--Wikidata ID（例：wd:Q7105556）：
			<input id="QID" type="text" value="wd:Q7105556" autocomplete="off" size="40"/><br> -->
			名称（例：大阪電気，大阪）：
			<input id="LABEL" type="text" value="" autocomplete="off" size="40"/><br>
		<!--所在地（例：寝屋川市，大阪府）：
			<input id="INPUT" type="text" value="" autocomplete="off" size="40"/><br>-->
		<!--設立年（XXXX年以降，1990）：
			<input id="YEAR" type="text" value="" autocomplete="off" size="40"/><br>-->
		<hr> 
		<!-- 下記の「クエリの表示・非表示」ボタンは，必要がなければコメントアウトしてもよい  -->
		<input type="button" id="dis_b" value="クエリの表示"
			onclick="document.getElementById('query').style.display = 'block';
			document.getElementById('dis_b').style.display = 'none';
			document.getElementById('none_b').style.display = 'block';">
		<input type="button" id="none_b"  value="クエリの非表示" style="display:none"
			onclick="document.getElementById('query').style.display = 'none';
			document.getElementById('dis_b').style.display = 'block';
			document.getElementById('none_b').style.display = 'none';">
	</div>

<div id="query" style="display:none">
置き換え前のクエリ：<br>
<!-- 一覧検索用のサンプルクエリ：[詳細表示]を試すときは下記のクエリと入れ替える-->
<textarea id="query_area" class="t_area" rows="10">
PREFIX wd: <http://www.wikidata.org/entity/>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX wikibase: <http://wikiba.se/ontology#>
	
select DISTINCT ?s ?sLabel ?p131Label ?p17Label ?p18 ?p856 ?p571
where{
	#VALUES #Wikidata APIで検索したIDとの置き換え用
	?s wdt:P31/wdt:P279* wd:Q3918 ;
		wdt:P17 wd:Q17; #国（wdt:P17）を日本（wd:Q17）に限定
		wdt:P131/rdfs:label|wdt:P131/wdt:P131/rdfs:label ?INPUT; #所在地（wdt:P131）
		wdt:P131 ?p131;
		wdt:P17 ?p17;
		wdt:P571 ?p571.
		OPTIONAL{
			?s wdt:P18 ?p18;
				wdt:P856 ?p856.
		}
	#?s rdfs:label ?LABEL.
	#FILTER(contains(?LABEL,"#LBL#"))
	#FILTER(?p571 >= "2000-01-01T00:00:00Z"^^xsd:dateTime)
	SERVICE wikibase:label { bd:serviceParam wikibase:language "ja,en". }
}LIMIT 50		
</textarea>
<!-- 詳細表示用のサンプルクエリ：[詳細表示]を試すときは上記のクエリと入れ替える-->
<!-- 
<textarea id="query_area" class="t_area" rows="10">
PREFIX wd: <http://www.wikidata.org/entity/>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX wikibase: <http://wikiba.se/ontology#>
    
select DISTINCT ?s ?sLabel ?o ?oLabel ?p ?prop ?propLabel
where{
    BIND(?QID AS ?s)
    ?s wdt:P31/wdt:P279* wd:Q3918 .
    ?s ?p ?o.
    FILTER(?p=wdt:P131
        || ?p=wdt:P17
        || ?p=wdt:P18
        || ?p=wdt:P856
        || ?p=wdt:P571)
    OPTIONAL{?prop wikibase:directClaim ?p.}
    SERVICE wikibase:label { bd:serviceParam wikibase:language "ja,en". }
}		
</textarea>	
-->
<br>
置き換え後のクエリ：<br>
<textarea id="query_area2" class="t_area" rows="10" >
</textarea>
<br>
クエリ実行結果の戻り値(JSON形式）：<br>
<textarea id="resjson_area"  class="t_area" rows="10" >
</textarea>
</div>

<input type="button" id="send" value="検索の実行" style="margin-top:8px; ">
</div>

<!-- 結果表示用の領域 -->
<div id="result_box" style=" display: none;  ">
	<div id="result_div"  class="container" style="flex: 1;"></div>
	<!-- 詳細表示画面を使用するときは，この下のコメントアウトを外す -->
	<!-- <div id="details_div" >
		<iframe src="" name="details"style="width: 340px; height: 600px;"></iframe>
	</div> -->
</div>
<hr>
</body>
</html>